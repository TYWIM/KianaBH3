<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>管理员后台</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
      :root { color-scheme: light; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #f7f7f7; color: #222; }
      .container { max-width: 960px; margin: 24px auto; padding: 24px; background: #fff; border: 1px solid #e5e5e5; border-radius: 12px; }
      h1 { font-size: 20px; margin: 0 0 16px; font-weight: 600; }
      .meta { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px; color: #555; }
      .card { padding: 16px; border: 1px solid #eee; border-radius: 12px; margin-bottom: 16px; }
      .row { display: flex; gap: 8px; align-items: center; }
      input[type="text"] { flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
      button { padding: 10px 16px; border: 1px solid #222; background: #222; color: #fff; border-radius: 8px; cursor: pointer; }
      button:disabled { opacity: 0.5; cursor: default; }
      table { width: 100%; border-collapse: collapse; }
      th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
      th { color: #444; font-weight: 600; }
      .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #ddd; font-size: 12px; color: #333; }
      .footer { margin-top: 16px; font-size: 12px; color: #777; }
      .footer a { color: inherit; text-decoration: underline; }
    </style>
  </head>
  <body>
    <div id="app" class="container" v-cloak>
      <h1>管理员后台</h1>
      <div class="meta">
        <div>服务器：{{ server.server_name }}</div>
        <div>版本：{{ server.version }}</div>
        <div>在线玩家：{{ server.player_count }}</div>
      </div>

      <div class="card">
        <div class="row" style="margin-bottom: 8px;">
          <input type="text" v-model.trim="announce" placeholder="输入要发送的世界公告" />
          <button @click="sendAnnounce" :disabled="sending || !announce">发送</button>
        </div>
        <div style="font-size: 12px; color: #777;">以服务器身份向所有在线玩家发送一条世界频道消息</div>
      </div>

      <div class="card">
        <div style="margin-bottom: 8px; font-weight: 600;">在线玩家</div>
        <table>
          <thead>
            <tr>
              <th>UID</th>
              <th>昵称</th>
              <th>等级</th>
              <th>状态</th>
              <th>最后活跃</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="u in users" :key="u.uid">
              <td>{{ u.uid }}</td>
              <td>{{ u.name }}</td>
              <td>{{ u.level }}</td>
              <td><span class="badge">{{ u.online ? '在线' : '离线' }}</span></td>
              <td>{{ formatTs(u.last_active_time) }}</td>
            </tr>
            <tr v-if="!users.length">
              <td colspan="5" style="color:#777;">暂无在线玩家</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="footer">
        <div>服务端作者：<a href="https://github.com/MikuLeaks/KianaBH3" target="_blank" rel="noopener">Miku</a></div>
        <div>后台作者：<a href="https://github.com/TYWIM/KianaBH3" target="_blank" rel="noopener">cxaim</a></div>
        <div>本服务端开源且免费，请勿倒卖</div>
      </div>
    </div>

    <script>
      const { createApp } = Vue
      createApp({
        data() {
          return { server: { server_name: '', version: '', player_count: 0 }, users: [], announce: '', sending: false }
        },
        mounted() { this.refresh() },
        methods: {
          async refresh() {
            try {
              const s = await fetch('/admin/server').then(r => r.json())
              this.server = s.data || {}
              const u = await fetch('/admin/users').then(r => r.json())
              this.users = (u.data && u.data.users) ? u.data.users : []
            } catch (e) { console.error(e) }
          },
          formatTs(ts) {
            if (!ts) return '-'
            const d = new Date(ts * 1000)
            return d.toLocaleString()
          },
          async sendAnnounce() {
            if (!this.announce) return
            this.sending = true
            try {
              await fetch('/admin/announce', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: this.announce }) })
              this.announce = ''
            } catch (e) { console.error(e) } finally { this.sending = false }
          }
        }
      }).mount('#app')
    </script>
  </body>
  </html>
